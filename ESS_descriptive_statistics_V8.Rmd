---
title: "Project Study"
author: "Helena Zappe"
date: "2025-06-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Download Packages

```{r install-packages, eval=FALSE, include=FALSE}
install.packages(c(
  "tidyverse",  # Datenaufbereitung & Visualisierung
  "skimr",      # Übersichtliche Daten-Zusammenfassung
  "psych",      # Deskriptive Statistik
  "rmarkdown",  # Für R Markdown selbst
  "knitr",      # Code-Ausgabe in R Markdown
  "tinytex",    # Nur für PDF-Export nötig
  "labelled"
  ))
tinytex::install_tinytex()  # Nur beim ersten Mal notwendig
```

# Load Packages

```{r load-packages, include=FALSE}
library(tidyverse)   # Bündelt ggplot2, dplyr, readr, etc. – für Datenimport, -aufbereitung, Visualisierung
library(skimr)       # Für übersichtliche Zusammenfassungen von Datensätzen
library(psych)       # Für deskriptive Statistiken (z.B. Mittelwert, SD, Median)
library(rmarkdown)   # Für das Erstellen von HTML/PDF-Dokumenten
library(knitr)       # Macht Code-Ausgabe in R Markdown hübsch und steuerbar
library(tinytex)     # Wird nur gebraucht, wenn du PDF-Dateien erstellst
library(labelled)
library(dplyr)
library(ggplot2)
library(tidyr)
library(forcats)
```

# Loading data

```{r}

setwd("/Users/test/Documents/Studium/Semester 6/Project Study")

dt_raw <- haven::read_sav(file.choose()) #ESS_all.sav

```

*`"What factors shapes trust in the European Union in Poland, Germany, and Slovenia? A comparative analysis of political attitudes, ideology, and socio-demographics."`*

# Data Wrangling

-   filtering to our countries
-   recoding age group
-   reversing the scale for polintr (higher number = more interested)
-   adjusting labels for ESS rounds
-   winsorizing education years to get rid of outliers

```{r data_preparation}

dt_all <- dt_raw %>%
  filter(cntry %in% c("DE", "PL", "SI")) %>%  
  mutate(
    age_group = case_when(
      agea < 18 ~ "<18",                      
      agea >=18 & agea <= 24 ~ "18-24",
      agea > 24 & agea <= 34 ~ "25-34",
      agea > 34 & agea <= 44 ~ "35-44",
      agea > 44 & agea <= 54 ~ "45–54",
      agea > 54 & agea <= 64 ~ "55-64",
      agea > 64 ~ "65+"
    ))  %>%                                   
  mutate(
    age_group = factor(age_group, levels = c("<18", "18-24", "25-34", "35-44", "45–54", "55-64", "65+")),
    polintr_rev = 5 - polintr  # higher = more interested               
    ) %>%
  mutate(year = case_when(    # Mapping ESS round to the year they were conducted in in "year"
    essround == 1 ~ 2002,
    essround == 2 ~ 2004,
    essround == 3 ~ 2006,
    essround == 4 ~ 2008,
    essround == 5 ~ 2010,
    essround == 6 ~ 2012,
    essround == 7 ~ 2014,
    essround == 8 ~ 2016,
    essround == 9 ~ 2018,
    essround == 10 ~ 2020,
    essround == 11 ~ 2022,
    TRUE ~ NA_real_
  )) %>%
    select(-c(agea, polintr, essround, trstun, trstplc, trstplt, trstprl, trstprt, name, pplfair, pplhlp, stfdem, imueclt, imdfetn, imbgeco, impcntr, badge))

```

```{r}
# winsorize education years to get rid of outliers
# Calculate thresholds
q_lower <- quantile(dt_all$eduyrs, 0.01, na.rm = TRUE)
q_upper <- quantile(dt_all$eduyrs, 0.99, na.rm = TRUE)

# Winsorize: replace values outside bounds
dt_all <- dt_all %>%
  mutate(eduyrs_winsor = case_when(
    eduyrs < q_lower ~ q_lower,
    eduyrs > q_upper ~ q_upper,
    TRUE ~ eduyrs
  )) %>%
select(-eduyrs)

```

```{r}
# Saving Data as new Dataset for Lasso

write_sav(dt_all, "ESS_prepared.sav") 

```

```{r raw_data, include=FALSE}

#Lade Daten und entferne nicht benötigte Variablen
dt_all <- haven::read_sav(file.choose()) 

#ESS_prepared.sav 

```

# LASSO to find best variables

```{r}

# Step 1: Preparing Data for Lasso
# using the gilmnet package
  
# filter variables with too many NAs:
dt_filtered <- dt_all %>%
  drop_na(trstep) %>% # keep only valid observations in y
  select(where(~ !all(is.na(.)))) %>% # 100% NAs
  select(where(~ mean(is.na(.)) <= 0.5)) %>% # keep variables with less than 80% NAs
 # select(-c(feethngr, loylead, lrnobed, donprty, volunfp, pbldmna, implvdm)) %>% # these variables are not relevant enough for imputation. Also households net income has 79% NAs and is therefore not meaningful. 
  select(-c(idno, proddate, bctprd, wrkorg, edition)) # Other variables that are not relevant for interpretation, stratum

# checking for missing variables in percent
dt_filtered %>%
  summarise(across(everything(), ~ mean(is.na(.)) * 100)) %>%
  pivot_longer(everything(), names_to = "variable", values_to = "missing_pct") %>%
  filter(missing_pct > 20) %>%
  arrange(desc(missing_pct))

# accounting for differences in country size and selection
dt_filtered <- dt_filtered %>% drop_na(anweight) # dropping all obs where anweight is NA
weights <- dt_filtered$anweight # establishing the weighting

# defining the response Variable
y <- as.numeric(as_factor(dt_filtered$trstep))
table(y, useNA = "always")

# define the predictor variable matrix
x_data <- dt_filtered %>%
  select(-c(trstep, anweight, pspwght, dweight, pweight)) %>% #prob
  zap_labels() %>%  # delete all labels
  mutate(across(where(is.factor), ~ as.numeric(as.character(.)))) # define all factor variables also as numeric

x_data[is.na(x_data)] <- 0  # replaces all NA in x_data

# define the matrix of response variables
x <- data.matrix(x_data)

# As long as you never change anything in dt_all (and you don't re‐run sample() anywhere else),
# calling cv.glmnet() right after this will always split into the same 10 folds.
set.seed(123) 

# LASSO with Crossvalidation and weighting

lasso_cv <- cv.glmnet(x, y, alpha = 1, weights = weights)

```

## Fitting the LASSO Model

The bigger lambda, the more coefficients will be set to 0 for variable selection.

**best_lambda** (lambda.min) gives the most precise model:

```{r}
# Find best Lambda
best_lambda <- lasso_cv$lambda.min

# Final LASSO Model
lasso_model <- glmnet(x, y, alpha = 1, lambda = best_lambda)

# Lambda Precise: 0.001855

# Extracting the Coefficients
coef_lasso <- coef(lasso_model)

selected_vars <- rownames(coef_lasso)[which(coef_lasso[, 1] != 0)]
selected_vars <- selected_vars[selected_vars != "(Intercept)"]

print(selected_vars)

```

**lambda.1se** gives the more robust, more economic (sparsamere) model: (Oft besser generalisierbar)

```{r}
lambda_1se <- lasso_cv$lambda.1se

model_robust <- glmnet(x, y, alpha = 1, lambda = lasso_cv$lambda.1se)

# Lambda Robust: 0.017295

# Extracting the Coefficients
coef_robust <- coef(model_robust)

vars_robust <- rownames(coef_robust)[which(coef_robust[, 1] != 0)]
vars_robust <- vars_robust[vars_robust != "(Intercept)"]

print(vars_robust)
```

Chatty: "In der LASSO-Analyse wurde mit lambda.min = 0.00140 das Modell mit der höchsten Vorhersagegenauigkeit identifiziert. Dieses Modell verwendet relativ viele Prädiktoren.

Alternativ wurde mit lambda.1se = 0.01575 ein robusteres Modell berechnet, das sparsamer ist und potenziell besser generalisiert. Hier bleiben nur die wichtigsten Prädiktoren erhalten.

Je nach Forschungsziel (Präzision vs. Interpretierbarkeit) kann eines der beiden Modelle bevorzugt werden."

## Model Specific Coefficients:

```{r}

# Vergleich
setdiff(selected_vars, vars_robust)  # Variablen nur im präzisen Modell
setdiff(vars_robust, selected_vars)  # Variablen nur im sparsamen Modell

```

```{r}
plot(lasso_cv)
abline(v = log(lasso_cv$lambda.min), col = "blue", lty = 3)
abline(v = log(lasso_cv$lambda.1se), col = "red", lty = 3)
abline(v = log(lambda_max), col = "green", lty = 3)
legend("topright", legend = c("lambda.min", "lambda.1se", "lambda_max"),
       col = c("blue", "red", "green"), lty = 3)
title("Cross-Validation: MSE über Lambda")
```

Chatty: - lambda.min (links) ergibt den niedrigsten mittleren Fehler – aber nutzt mehr Prädiktoren - lambda.1se (weiter rechts) hat leicht höheren Fehler, ist aber viel sparsamer Der Plot zeigt schön, dass der Fehler in einem sehr flachen Bereich minimal ist → daher kannst du das robustere, sparsamere Modell (lambda.1se) gut vertreten.

-\> Wir verwenden also die Variablen vom 2. Modell oder grenzen es weiter manuell ein.

## Neues Datenset lambda_max

```{r}
#dt_lasso_selected <- dt_all %>% select(all_of(vars_robust), trstep)
# insg. 66 variables (zu viele)
```

## Alternative: Interpretierbareres Modell mit max x Variablen

```{r}
lasso_model_max <- glmnet(x, y, alpha = 1, dfmax = 14)

# Extracting the Coefficients
coef_lasso <- coef(lasso_model_max)

# Anzahl ≠ 0-Koeffizienten je Lambda (inkl. Intercept)
nonzero <- lasso_model_max$df
lambda_index <- which(nonzero == 14)[1]  # x Prädiktoren + 1 Intercept

# Wenn gefunden:
if (!is.na(lambda_index)) {
  lambda_max <- lasso_model_max$lambda[lambda_index]
  coef_max <- coef(lasso_model_max, s = lambda_max)
  vars_max <- rownames(coef_max)[which(coef_max[, 1] != 0)]
  vars_max <- vars_max[vars_max != "(Intercept)"]
  print(vars_max)
} else {
  message("Kein Lambda mit genau x Prädiktoren gefunden.")
}
```


### Cutoff ausprobieren:

Chatty empfiehlt 10-30 Variablen

(Je geringer lambda, desto genauer passt das Model.) 

- Lambda 10 vars = not found 
- Lambda 15 vars = 0.1245 
- Lambda 16 vars = 0.1134
- Lambda 17 vars = not found
- Lambda 18 vars = 0.0858
- Lambda 19 vars = not found
- Lambda 20 vars = not found 
- Lambda 25 vars = 0.0591 
- Lambda 30 vars = not found 

Ich glaube 15 oder max. 20 sollten genug sein, sonst ist es zu viel.

### Neues Subset aus lambda_max 

```{r}
dt_lasso_selected <- dt_filtered %>% select(all_of(vars_max), trstep)
# insg. 15 variables

```

### Neues Subset mit originaler Codierung und Labels, aber nur lambda_max variablen

```{r}
#1. Neues Datenset mit Originalstruktur erstellen
  dt_lasso_labeled <- dt_all %>%
    select(all_of(vars_max), trstep)  
  
#2. Nur gültige Fälle von trstep behalten 
  dt_lasso_labeled <- dt_lasso_labeled %>%
    drop_na(trstep)  

#3. Optional: Labels prüfen
  library(labelled)
  look_for(dt_lasso_labeled)
```

### Speichern des Datensets in Dateien

```{r}
write_sav(dt_lasso_labeled, "ESS_lasso.sav")

```

# Descriptive Statistics
## Summary Statistics of Variables by Country
Wichtige Variablen:
 [1] "cntry"   "ppltrst" "euftf"   "freehms" "stfedu"  "stfgov"  "stfhlth"
 [8] "trstlgl" "vote"    "imwbcnt" "health"  "rlgatnd" "gndr"    "year"
 
```{r}
summary_table <- dt_lasso_labeled %>%
  group_by(cntry) %>%
  summarise(across(
    c(ppltrst, euftf, freehms, stfedu, stfgov, stfhlth, trstlgl, vote, imwbcnt, health, rlgatnd, gndr, year, trstep),
    list(mean = ~mean(.x, na.rm = TRUE),
         median = ~median(.x, na.rm = TRUE),
         Q5 = ~quantile(.x, 0.05, na.rm = TRUE),
         Q95 = ~quantile(.x, 0.95, na.rm = TRUE))
  )) 

View(as.data.frame(summary_table))

```

-   Mean political interest highest in Germany and lowest in Slovenia
-   Education years highest in Germany and lowest in Slovenia
-   On the left-right scale, Germany is the leftest and Poland the one the furthest right
-   Satisfaction with democracy highest in Germany and lowest in Slovenia
-   Satisfaction with government highest in Germany and lowest in Poland
-   Immigration attitude towards immigrants highest in Poland and lowest in Slovenia
-   Trust in politicians highest in Germany and lowest in Poland, but very low across all countries
-   Trust in EU highest in Poland and lowest in Germany, but only very small differences

## Summary Statistics of Trust in EU by Country

```{r}
dt_lasso_labeled %>%
  group_by(cntry) %>%
  summarise(across(
    c(trstep),
    list(mean = ~mean(.x, na.rm = TRUE),
         median = ~median(.x, na.rm = TRUE),
         Q5 = ~quantile(.x, 0.05, na.rm = TRUE),
         Q95 = ~quantile(.x, 0.95, na.rm = TRUE))
  ))

```

-   Mean trust in EU is rather similar across all three countries

# Visualization

## Distribution of Gender by Country

```{r}

dt_filtered %>%
  mutate(gndr = as_factor(gndr)) %>%  # convert haven_labelled to factor
  count(cntry, gndr) %>%
  group_by(cntry) %>%
  mutate(prop = n / sum(n) * 100) %>%
  ggplot(aes(x = cntry, y = prop, fill = gndr)) +
  geom_col(position = "dodge") +
  labs(
    title = "Relative Distribution of Gender by Country",
    x = "Country",
    y = "Proportion of Respondents",
    fill = "Gender"
  ) +
  theme_minimal()

```

- distribution among all three countries rather similar around 50% for each gender
- Germany has slightly more male respondents
- Poland and Slovenia have slightly more female respondents
- gap is the highest in Slovenia

## Distribution of Voting Behavior

```{r}

# Filtering to valid left-right scale values
vote_data <- dt_filtered %>%
  filter(!is.na(vote)) %>%
  group_by(cntry, vote) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(cntry) %>%
  mutate(percentage = count / sum(count) * 100)


#Plotting the diverging stacked bar chart
ggplot(vote_data, aes(x = cntry, y = percentage, fill = factor(vote, levels = rev(0:3)))) +
  geom_bar(stat = "identity", position = "stack") +
  coord_flip() +
  scale_fill_manual(
    values = c(
      "1" = "#002060", "2" = "#4A90E2", "3" = "#DDDDDD"
    ),
    name = "Voted Last National Election"
  ) +
  labs(
    title = "Distribution of Voting Behavior",
    x = NULL,
    y = "Percentage (%)"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

- highest proportion of voters in Germany
- Slovenia has the highest share of people that did not vote


## Trust in EU over Time for all three Countries 
### Option 1

```{r}

# Summarize mean trust per country and year

trust_trends <- dt_filtered %>%
  filter(cntry %in% c("DE", "PL", "SI")) %>%
  group_by(cntry, year) %>%
  summarise(
    trust_EU = mean(trstep, na.rm = TRUE),
    .groups = "drop"
  ) 

#Reshaping to long format for plotting
trust_long <- trust_trends %>%
  pivot_longer(cols = c(trust_EU),
               names_to = "institution",
               values_to = "trust")

#Plotting the time trend
ggplot(trust_long, aes(x = year, y = trust, color = institution, linetype = institution)) +
  geom_line(size = 1) +
  facet_wrap(~cntry) +
  labs(
    title = "Trust in the EU over Time",
    x = "Year",
    y = "Mean Trust Level",
    color = "Institution",
    linetype = "Institution"
  ) +
  theme_minimal()

```

-   Slovenia shows the highest fluctuations in mean trust in the EU, with a sharp decline between 2006 and 2014

### Option 2

```{r}

ggplot(trust_trends, aes(x = year, y = trust_EU, color = cntry)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  scale_color_manual(
    values = c(
      "DE" = "#33658a",  # Germany
      "PL" = "#f6ae2d",  # Poland
      "SI" = "#f26419"   # Slovenia
    ),
    labels = c("DE" = "Germany", "PL" = "Poland", "SI" = "Slovenia")
  ) +
  labs(
    title = "Trust in the EU Over Time",
    x = "Year",
    y = "Mean Trust in EU",
    color = "Country"
  ) +
  theme_minimal()


```

-   strong flucutations over time fro all three countries
-   mean trust in Slovenia peaked in 2006 and was the lowest in 2014
-   mean trust in Poland peaked in 2002 and was the lowest in 2014
-   mean trust in Germany peaked in 2023 and was the lowest in 2010

## Distribution of Age Groups

```{r}

dt_filtered %>%
  count(cntry, age_group) %>%
  group_by(cntry) %>%
  mutate(prop = n / sum(n) * 100) %>%
  ggplot(aes(x = cntry, y = prop, fill = age_group)) +
  geom_col(position = "dodge") +
  labs(
    title = "Relative Distribution of Age Groups by Country",
    x = "Country",
    y = "Proportion of Respondents",
    fill = "Age Group"
  ) +
  theme_minimal()

```

-   Among all countries, the age group "65+" has the highest share
-   Age distribution has an upward trend in all three countries, indicating an aging population

## Average Trust in EU by Age Group and Country

```{r}
dt_filtered %>%
  group_by(cntry, age_group) %>%
  summarise(mean_trustEU = mean(trstep, na.rm = TRUE), .groups = "drop") %>%
  ggplot(aes(x = age_group, y = mean_trustEU, fill = cntry)) +
  geom_col(position = "dodge") +
  scale_fill_manual(
    values = c(
      "DE" = "#33658a",     # Germany - Blue
      "PL" = "#f6ae2d",     # Poland - Light Orange
      "SI" = "#f26419"      # Slovenia - Dark Orange/Pink
    ),
    labels = c(
      "DE" = "Germany",
      "PL" = "Poland",
      "SI" = "Slovenia"
    )
  ) +
  labs(
    title = "Average Trust in EU by Age Group and Country",
    x = "Age Group",
    y = "Mean Trust in EU",
    fill = "Country"
  ) +
  theme_minimal()

```

-   highest mean trust in EU among people younger than 18 in all three countries, with respondents from Germany having the highest trust
-   general downward trend in meant trust in EU across all countries up to the age group 55-64
-   trust increases again for respondents being 65 or older

## Average Trust in Politicians by Age Group and Country

```{r}
dt_filtered %>%
  group_by(cntry, age_group) %>%
  summarise(mean_trustpol = mean(polintr_rev, na.rm = TRUE), .groups = "drop") %>%
  ggplot(aes(x = age_group, y = mean_trustpol, fill = cntry)) +
  geom_col(position = "dodge") +
  scale_fill_manual(
    values = c(
      "DE" = "#33658a",     # Germany - Blue
      "PL" = "#f6ae2d",     # Poland - Light Orange
      "SI" = "#f26419"      # Slovenia - Dark Orange/Pink
    ),
    labels = c(
      "DE" = "Germany",
      "PL" = "Poland",
      "SI" = "Slovenia"
    )
  ) +
  labs(
    title = "Average Trust in Politicians by Age Group and Country",
    x = "Age Group",
    y = "Mean Trust in Politicians",
    fill = "Country"
  ) +
  theme_minimal()
```

-   clearly highest trust in politicians in Germany among all age groups
-   Polish respondents seem to have higher trust than Slovenian respondents in all age groups, except for the group 55-64 

## Left-Right Political Placement across Countries

```{r}

# Filtering to valid left-right scale values
lr_data <- dt_filtered %>%
  filter(!is.na(lrscale)) %>%
  group_by(cntry, lrscale) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(cntry) %>%
  mutate(percentage = count / sum(count) * 100)


#Plotting the diverging stacked bar chart
ggplot(lr_data, aes(x = cntry, y = percentage, fill = factor(lrscale, levels = rev(0:10)))) +
  geom_bar(stat = "identity", position = "stack") +
  coord_flip() +
  scale_fill_manual(
    values = c(
      "0" = "#00002E", "1" = "#002060", "2" = "#003090", "3" = "#4A90E2",
      "4" = "#8AB4F8", "5" = "#DDDDDD",
      "6" = "#FFE399", "7" = "#FFBE5C", "8" = "#FF914D", "9" = "#C23B22", "10" = "#800000"
    ),
    name = "Left-Right Scale"
  ) +
  labs(
    title = "Placement on Left-Right Political Scale",
    x = NULL,
    y = "Percentage (%)"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

-   highest share of respondents selected 5 as their political attitude
-   higher share of respondents in Germany and Slovenia are rather left
-   higher share of respondents in Poland are rather right

## Satisfaction with National Government 
### by Country Over Time

```{r}

# Ensure year is treated properly
dt_filtered %>%
  filter(!is.na(stfgov), !is.na(year)) %>%
  group_by(cntry, year, stfgov) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(cntry, year) %>%
  mutate(percentage = count / sum(count) * 100) %>%
  ggplot(aes(x = cntry, y = percentage, fill = factor(stfgov, levels = rev(0:10)))) +
  geom_bar(stat = "identity", position = "stack") +
  coord_flip() +
  facet_wrap(~year) +
  scale_fill_manual(
    values = c(
      "0" = "#00002E", "1" = "#002060", "2" = "#003090", "3" = "#4A90E2",
      "4" = "#8AB4F8", "5" = "#DDDDDD",
      "6" = "#FFE399", "7" = "#FFBE5C", "8" = "#FF914D", "9" = "#C23B22", "10" = "#800000"
    ),
    name = "Satisfaction"
  ) +
  labs(
    title = "Satisfaction with National Government by Country over Time",
    x = NULL,
    y = "Percentage (%)"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

- satisfation with national government fluctuated over time among all countries 
- Polish respondents were very dissatisfied in 2020
- German respondents were very dissatisfied in 2002
- Slovenian respondents were very dissatisfied in 2012

### by Country over Time on Average

```{r}
dt_filtered %>%
  filter(!is.na(stfgov), !is.na(year)) %>%
  group_by(cntry, year) %>%
  summarise(mean_stfgov = mean(stfgov, na.rm = TRUE), .groups = "drop") %>%
  ggplot(aes(x = year, y = mean_stfgov, color = cntry, group = cntry)) +
  geom_line(size = 1) +
  geom_point() +
  labs(
    title = "Average Satisfaction with National Government Over Time",
    x = "Year",
    y = "Average Satisfaction (0–10 scale)",
    color = "Country"
  ) +
  theme_minimal()

```


## Years of Education 
### by Country

```{r}
ggplot(dt_filtered, aes(x = cntry, y = eduyrs_winsor, fill = cntry)) +
  geom_boxplot() +
  scale_fill_manual(
    values = c(
      "DE" = "#33658a",   # Germany - Blue
      "PL" = "#f6ae2d",   # Poland - Light Orange
      "SI" = "#f26419"    # Slovenia - Dark Orange/Pink
    ),
    labels = c("DE" = "Germany", "PL" = "Poland", "SI" = "Slovenia")
  ) +
  labs(title = "Education Years by Country",
       y = "Years of Education", x = "Country")

```

- we winsorized outliers earlier
- highest years of education in Germany

### by Age Group and Country

```{r}
dt_filtered %>%
  group_by(age_group, cntry) %>%
  summarise(mean_eduyrs = mean(eduyrs_winsor, na.rm = TRUE), .groups = "drop") %>%
  ggplot(aes(x = age_group, y = mean_eduyrs, fill = cntry)) +
  geom_col(position = "dodge") +
  scale_fill_manual(
    values = c(
      "DE" = "#33658a",   # Germany
      "PL" = "#f6ae2d",   # Poland
      "SI" = "#f26419"    # Slovenia
    ),
    labels = c("DE" = "Germany", "PL" = "Poland", "SI" = "Slovenia")
  ) +
  labs(
    title = "Mean Years of Education by Age Group and Country",
    x = "Age Group",
    y = "Mean Years of Education",
    fill = "Country"
  ) +
  theme_minimal()
```

-   graph illustrates differences among age groups across countries
-   Germany has the highest average years of education among all age groups, followed by Poland

## Attitudes towards Immigrants 
### by Age Group and Country

```{r}
dt_filtered %>%
  group_by(age_group, cntry) %>%
  summarise(mean_imwbcnt = mean(imwbcnt, na.rm = TRUE), .groups = "drop") %>%
  ggplot(aes(x = age_group, y = mean_imwbcnt, fill = cntry)) +
  geom_col(position = "dodge") +
  scale_fill_manual(
    values = c(
      "DE" = "#33658a",   # Germany
      "PL" = "#f6ae2d",   # Poland
      "SI" = "#f26419"    # Slovenia
    ),
    labels = c("DE" = "Germany", "PL" = "Poland", "SI" = "Slovenia")
  ) +
  labs(
    title = "Attitudes towards Immigrants by Age Group and Country",
    x = "Age Group",
    y = "Attitudes towards Immigrants",
    fill = "Country"
  ) +
  theme_minimal()
```

-   Polish respondents seem to be more welcoming of immigrants among all age groups
-   Slovenian respondents seem to be the least welcoming of immigrants among all age groups
-   this seems to be a contradiction to the distribution of the left-right scale, where a higher share of Polish respondents indicated to be more right, and a higher share of Slovenian respondents indicated to be more left
-   a boxplot in the next step could help to check for outliers
-   reasons??

### per Country

```{r}
ggplot(dt_filtered, aes(x = cntry, y = imwbcnt, fill = cntry)) +
  geom_boxplot() +
  scale_fill_manual(
    values = c(
      "DE" = "#33658a",   # Germany - Blue
      "PL" = "#f6ae2d",   # Poland - Light Orange
      "SI" = "#f26419"    # Slovenia - Dark Orange/Pink
    ),
    labels = c("DE" = "Germany", "PL" = "Poland", "SI" = "Slovenia")
  ) +
  labs(title = "Immigration Attitude by Country",
       y = "Immigration Attitude", x = "Country")
```

-   there do not seem to be high outliers for positive immigration attitude among Polish respondents
-   Why are Polish respondents so welcoming when they are rather right? Would be interesting to see if the respondents who are rather right are also more welcoming, or if the average is high because of the very high immigration attitude among rather left respondents

## Trust in People by Country

```{r}
ggplot(dt_filtered, aes(x = cntry, y = ppltrst, fill = cntry)) +
  geom_boxplot() +
  scale_fill_manual(
    values = c(
      "DE" = "#33658a",   # Germany - Blue
      "PL" = "#f6ae2d",   # Poland - Light Orange
      "SI" = "#f26419"    # Slovenia - Dark Orange/Pink
    ),
    labels = c("DE" = "Germany", "PL" = "Poland", "SI" = "Slovenia")
  ) +
  labs(title = "Trust in People by Country",
       y = "Trust", x = "Country")
```

- lowest trust in people in Poland

## Unification Progress Satisfaction 
### by Country on Average
Higher values indicate a stronger desire for unification.
```{r}
# Filtering to valid scale values
eu_data <- dt_filtered %>%
  filter(!is.na(euftf)) %>%
  group_by(cntry, euftf) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(cntry) %>%
  mutate(percentage = count / sum(count) * 100)


#Plotting the diverging stacked bar chart
ggplot(eu_data, aes(x = cntry, y = percentage, fill = factor(euftf, levels = rev(0:10)))) +
  geom_bar(stat = "identity", position = "stack") +
  coord_flip() +
  scale_fill_manual(
    values = c(
      "0" = "#00002E", "1" = "#002060", "2" = "#003090", "3" = "#4A90E2",
      "4" = "#8AB4F8", "5" = "#DDDDDD",
      "6" = "#FFE399", "7" = "#FFBE5C", "8" = "#FF914D", "9" = "#C23B22", "10" = "#800000"
    ),
    name = "European Unification Go Further or Gone Too Far"
  ) +
  labs(
    title = "Satisfaction with Unification by Country",
    x = NULL,
    y = "Percentage (%)"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

- in all three countries, the majority of repsondents voted values above average, indicating they want the unification to go further

### by Country Over Time

```{r}
# Ensure year is treated properly
dt_filtered %>%
  filter(!is.na(euftf), !is.na(year)) %>%
  group_by(cntry, year, euftf) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(cntry, year) %>%
  mutate(percentage = count / sum(count) * 100) %>%
  ggplot(aes(x = cntry, y = percentage, fill = factor(euftf, levels = rev(0:10)))) +
  geom_bar(stat = "identity", position = "stack") +
  coord_flip() +
  facet_wrap(~year) +
  scale_fill_manual(
    values = c(
      "0" = "#00002E", "1" = "#002060", "2" = "#003090", "3" = "#4A90E2",
      "4" = "#8AB4F8", "5" = "#DDDDDD",
      "6" = "#FFE399", "7" = "#FFBE5C", "8" = "#FF914D", "9" = "#C23B22", "10" = "#800000"
    ),
    name = "European Unification Go Further or Gone Too Far"
  ) +
  labs(
    title = "Satisfaction with Unification by Country and Year",
    x = NULL,
    y = "Percentage (%)"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")
```


## Support for Free Lives of Gays and Lesbians 
### by Age Group and Country
Higher values indicate that a respondent disagrees more strongly. Maybe reverse scale here as well, as it is a bit counter intuitive?

```{r}
dt_filtered %>%
  group_by(age_group, cntry) %>%
  summarise(mean_freehms = mean(freehms, na.rm = TRUE), .groups = "drop") %>%
  ggplot(aes(x = age_group, y = mean_freehms, fill = cntry)) +
  geom_col(position = "dodge") +
  scale_fill_manual(
    values = c(
      "DE" = "#33658a",   # Germany
      "PL" = "#f6ae2d",   # Poland
      "SI" = "#f26419"    # Slovenia
    ),
    labels = c("DE" = "Germany", "PL" = "Poland", "SI" = "Slovenia")
  ) +
  labs(
    title = "Gays and Lesbians are free to live as they wish",
    x = "Age Group",
    y = "Attitudes towards Gays and Lesbians",
    fill = "Country"
  ) +
  theme_minimal()
```

- strong differences between Germany and the other two countries
- respondents from Germany responded with clearly lower values among all age groups, indicating they agree that homosexual people are free to live as they wish
- Poland has the highest values among all age groups, but only slightly higher than Slovenian repsondents
- values for the two countries are around 3, indicating they neither agree nor disagree
- this suggests they dont oppose homosexual couples, but they tend to be less liberal than German respondents
- general upward trend beginning at the group "18-24"

### by Age Group and Country over Time

```{r}
dt_filtered %>%
  filter(!is.na(freehms), !is.na(year)) %>%
  group_by(year, cntry, age_group) %>%
  summarise(mean_freehms = mean(freehms, na.rm = TRUE), .groups = "drop") %>%
  ggplot(aes(x = year, y = mean_freehms, color = cntry, group = cntry)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  facet_wrap(~age_group) +
  scale_color_manual(
    values = c(
      "DE" = "#33658a",
      "PL" = "#f6ae2d",
      "SI" = "#f26419"
    ),
    labels = c("DE" = "Germany", "PL" = "Poland", "SI" = "Slovenia")
  ) +
  labs(
    title = "Attitudes Toward Gays and Lesbians Over Time",
    subtitle = "Mean agreement with 'Gays and Lesbians are free to live as they wish'",
    x = "Year",
    y = "Mean Attitude Score",
    color = "Country"
  ) +
  theme_minimal()

```

- this graph reveals that there was a downward trend over time among all countries and age gorups, indicating that respondents became more welcoming towards gays and lesbians

## Satisfaction with State of Education by Country
### by Country On Average

```{r}
# Filtering to valid scale values
edu_data <- dt_filtered %>%
  filter(!is.na(stfedu)) %>%
  group_by(cntry, stfedu) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(cntry) %>%
  mutate(percentage = count / sum(count) * 100)


#Plotting the diverging stacked bar chart
ggplot(edu_data, aes(x = cntry, y = percentage, fill = factor(stfedu, levels = rev(0:10)))) +
  geom_bar(stat = "identity", position = "stack") +
  coord_flip() +
  scale_fill_manual(
    values = c(
      "0" = "#00002E", "1" = "#002060", "2" = "#003090", "3" = "#4A90E2",
      "4" = "#8AB4F8", "5" = "#DDDDDD",
      "6" = "#FFE399", "7" = "#FFBE5C", "8" = "#FF914D", "9" = "#C23B22", "10" = "#800000"
    ),
    name = "State of Education in Country Nowadays"
  ) +
  labs(
    title = "Satisfaction with State of Education by Country",
    x = NULL,
    y = "Percentage (%)"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

- highest satisfaction with education to be seen in Slovenia, followed by Poland and then Germany

### by Country Over Time

```{r}
# Ensure year is treated properly
dt_filtered %>%
  filter(!is.na(stfedu), !is.na(year)) %>%
  group_by(cntry, year, stfedu) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(cntry, year) %>%
  mutate(percentage = count / sum(count) * 100) %>%
  ggplot(aes(x = cntry, y = percentage, fill = factor(stfedu, levels = rev(0:10)))) +
  geom_bar(stat = "identity", position = "stack") +
  coord_flip() +
  facet_wrap(~year) +
  scale_fill_manual(
    values = c(
      "0" = "#00002E", "1" = "#002060", "2" = "#003090", "3" = "#4A90E2",
      "4" = "#8AB4F8", "5" = "#DDDDDD",
      "6" = "#FFE399", "7" = "#FFBE5C", "8" = "#FF914D", "9" = "#C23B22", "10" = "#800000"
    ),
    name = "Satisfaction"
  ) +
  labs(
    title = "Satisfaction with State of Education by Country and Year",
    x = NULL,
    y = "Percentage (%)"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")

```


## Satisfaction with the State of Health within Country
### by Country over Time

```{r}

# Ensure year is treated properly
dt_filtered %>%
  filter(!is.na(stfhlth), !is.na(year)) %>%
  group_by(cntry, year, stfhlth) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(cntry, year) %>%
  mutate(percentage = count / sum(count) * 100) %>%
  ggplot(aes(x = cntry, y = percentage, fill = factor(stfhlth, levels = rev(0:10)))) +
  geom_bar(stat = "identity", position = "stack") +
  coord_flip() +
  facet_wrap(~year) +
  scale_fill_manual(
    values = c(
      "0" = "#00002E", "1" = "#002060", "2" = "#003090", "3" = "#4A90E2",
      "4" = "#8AB4F8", "5" = "#DDDDDD",
      "6" = "#FFE399", "7" = "#FFBE5C", "8" = "#FF914D", "9" = "#C23B22", "10" = "#800000"
    ),
    name = "Satisfaction"
  ) +
  labs(
    title = "Satisfaction with State of Health by Country over Time",
    x = NULL,
    y = "Percentage (%)"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

### by Country over Time on Average

```{r}
dt_filtered %>%
  filter(!is.na(stfhlth), !is.na(year)) %>%
  group_by(cntry, year) %>%
  summarise(mean_stfhlth = mean(stfhlth, na.rm = TRUE), .groups = "drop") %>%
  ggplot(aes(x = year, y = mean_stfhlth, color = cntry, group = cntry)) +
  geom_line(size = 1) +
  geom_point() +
  labs(
    title = "Average Satisfaction with State of Health by Country over Time",
    x = "Year",
    y = "Average Satisfaction (0–10 scale)",
    color = "Country"
  ) +
  theme_minimal()
```

- Germany peaked around 2016 just above 6, also the highest value among all three countries, but satisfaction declined after that
- Polish satisfaction crashed to under 3 in 2020 
- values from Polish respondents are the lowest among all three countries

## Subjective General Health 
### by Country over Time
Lower values indicate higher satisfaction (reverse scale?)
```{r}

# Ensure year is treated properly
dt_filtered %>%
  filter(!is.na(health), !is.na(year)) %>%
  group_by(cntry, year, health) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(cntry, year) %>%
  mutate(percentage = count / sum(count) * 100) %>%
  ggplot(aes(x = cntry, y = percentage, fill = factor(health, levels = rev(0:5)))) +
  geom_bar(stat = "identity", position = "stack") +
  coord_flip() +
  facet_wrap(~year) +
  scale_fill_manual(
    values = c(
      "0" = "#00002E", "1" = "#002060", "2" = "#003090", "3" = "#4A90E2",
      "4" = "#8AB4F8", "5" = "#DDDDDD"
    ),
    name = "State of Health"
  ) +
  labs(
    title = "Subjective State of Health by Country over Time",
    x = NULL,
    y = "Percentage (%)"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

- relatively similar distribution over time across all three countries

### by Country over Time on Average

```{r}
dt_filtered %>%
  filter(!is.na(health), !is.na(year)) %>%
  group_by(cntry, year) %>%
  summarise(mean_health = mean(health, na.rm = TRUE), .groups = "drop") %>%
  ggplot(aes(x = year, y = mean_health, color = cntry, group = cntry)) +
  geom_line(size = 1) +
  geom_point() +
  labs(
    title = "Average Subjective State of Health by Country over Time",
    x = "Year",
    y = "Average State (0–10 scale)",
    color = "Country"
  ) +
  theme_minimal()
```

- this graph reveals strong fluctuations, but looking at the scale, they are all somewhat between the values 2 and 3, so they are really not that strong
- what is still surprising though, is the higher value of Polish respondents in 2020, compared to the low satisfaction values of other variables in 2020


## Trust in the Legal System by Country over Time on Average

```{r}

dt_filtered %>%
  filter(!is.na(trstlgl), !is.na(year)) %>%
  group_by(cntry, year) %>%
  summarise(mean_trstlgl = mean(trstlgl, na.rm = TRUE), .groups = "drop") %>%
  ggplot(aes(x = year, y = mean_trstlgl, color = cntry, group = cntry)) +
  geom_line(size = 1) +
  geom_point() +
  labs(
    title = "Trust in the legal System by Country over Time",
    x = "Year",
    y = "Average State (0–10 scale)",
    color = "Country"
  ) +
  theme_minimal()

```
- Germany has by far the highest trust in the legal system with a general upward trend
- Responses from Poland and Slovenia fluctuate more 
- strong upward trend in Slovenia since 2014
- lowest value in Slovenia with just above 3 in 2010
- lowest value in Poland with just above 3 in 2020


## Attendance of Religious Services apart from Special Occasions
### by Country over Time
Lower values indicate that a respondent attends more often (reverse scale?)

```{r}
# Ensure year is treated properly
dt_filtered %>%
  filter(!is.na(rlgatnd), !is.na(year)) %>%
  group_by(cntry, year, rlgatnd) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(cntry, year) %>%
  mutate(percentage = count / sum(count) * 100) %>%
  ggplot(aes(x = cntry, y = percentage, fill = factor(rlgatnd, levels = rev(0:7)))) +
  geom_bar(stat = "identity", position = "stack") +
  coord_flip() +
  facet_wrap(~year) +
  scale_fill_manual(
    values = c(
      "0" = "#00002E", "1" = "#002060", "2" = "#003090", "3" = "#4A90E2",
      "4" = "#8AB4F8", "5" = "#DDDDDD",
      "6" = "#FFE399", "7" = "#FFBE5C"
    ),
    name = "Frequency"
  ) +
  labs(
    title = "Attendance of Religious Services apart from Special Occasions",
    x = NULL,
    y = "Percentage (%)"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")
```
- Much higher share of Polish respondents attends religious services more often
- Slovenia is somewhat evenly distributed
- Germany has the highest shares of respondnets that never attend religious services throughout all the years

### by Country over Time on Average

```{r}
dt_filtered %>%
  filter(!is.na(rlgatnd), !is.na(year)) %>%
  group_by(cntry, year) %>%
  summarise(mean_rlgatnd = mean(rlgatnd, na.rm = TRUE), .groups = "drop") %>%
  ggplot(aes(x = year, y = mean_rlgatnd, color = cntry, group = cntry)) +
  geom_line(size = 1) +
  geom_point() +
  labs(
    title = "Attendance of Religious Services apart from Special Occasions",
    x = "Year",
    y = "Average Frequency (0–7 scale)",
    color = "Country"
  ) +
  theme_minimal()
```

- Germany on average the country with the least attendance, followed by Slovenia and then Poland
- Poland is by far the country with the highest attendance, even though there is an upward trend that peaked in 2020



# Models
## Correlation Matrix

```{r}
# Select relevant variables
dt_cor <- dt_filtered %>% select(ppltrst, euftf, freehms, stfedu, stfgov, stfhlth, trstlgl, imwbcnt, rlgatnd, gndr, year, trstep, clsprty, age_group) #I use agea because age_group is a fator variable which I can not use for correlation matrix

# Calculate correlation matrix (pairwise complete cases)
cor(dt_cor, use = "pairwise.complete.obs")
```



## Baseline Linear Model with all Variables as Predictors

```{r}

model1 <- lm(trstep ~ ppltrst + euftf + freehms + stfedu + stfgov + stfhlth + trstlgl + imwbcnt + rlgatnd + gndr + year + clsprty + age_group + cntry,
             data = dt_filtered)
summary(model1)

```

### Interpretation

**Model Overview**

* **Dependent variable**: `trstep` – trust in the EU (0–10 scale)
* **N** = 37,297 (after removing 17,244 rows with missing values)
* **R² = 0.364** – The model explains \~36% of the variation in EU trust, which is quite good for social science research
* **Residual SE = 1.98** – The typical prediction error is about 2 points on a 0–10 scale
* **Country controls (`cntry`)** are included, with Germany as the reference group
* All predictors are statistically significant at p < 0.001 except **`rlgatnd`**, which is **not significant**.


*Institutional and Political Attitudes*

* **`trstlgl` (+0.29)**: Trust in the legal system is the **strongest predictor** of EU trust. A one-unit increase is associated with a **0.29-point increase** in EU trust.
* **`euftf` (+0.21)**: Stronger support for European unification correlates with significantly higher trust in the EU.
* **`stfgov` (+0.15)**: Satisfaction with national government substantially boosts trust in the EU.
* **`stfedu` (+0.06)** and **`stfhlth` (+0.04)**: Satisfaction with education and healthcare modestly increase EU trust.
* **`ppltrst` (+0.05)**: Greater interpersonal trust is positively associated with EU trust.
* **`freehms` (−0.10)**: Belief that homosexuals are not free in society slightly **reduces** EU trust (higher scores = more disagreement with the statement that homosexuals are free).
* **`imwbcnt` (+0.07)**: Positive attitudes toward immigrants are associated with increased EU trust.

*Demographics*

* **`gndr` (+0.29)**: Being female (if coded as 1) is linked to **higher** trust in the EU.
* **`age_group` (−0.13)**: Older age groups tend to trust the EU **less**.
* **`rlgatnd` (ns)**: Religious attendance is **not significantly** related to EU trust.

*Time Trend*

* **`year` (−0.019)**: Trust in the EU has slightly **declined** over time — about **0.019 points per year**.

*Country Differences* (relative to Germany)

* **`cntryPL` (+0.72)**: Respondents in **Poland** report **significantly higher** trust in the EU compared to Germans.
* **`cntrySI` (+0.77)**: Respondents in **Slovenia** also have **higher** trust in the EU than Germans.


*People who trust others, trust their legal system, support further EU unification, and are satisfied with their national institutions (especially government) tend to trust the EU more. Trust is higher in Poland and Slovenia than Germany, and has declined slightly over time.*


##Separate Models per Country for Comparison 
This avoids running regressions with interactions, that give long outputs that are hard to interpret.

### Baseline Linear Model for Poland

```{r}
model_PL <- lm(trstep ~ ppltrst + euftf + freehms + stfedu + stfgov + stfhlth + trstlgl + imwbcnt + rlgatnd + gndr + year + clsprty + age_group,
               data = filter(dt_filtered, cntry == "PL"))

summary(model_PL)
```

- stfedu are not statistically significant
- trstlgl, euftf, clsprty and gender are strongest predictors

### Baseline Linear Model for Slovenia
```{r}
model_SI <- lm(trstep ~ ppltrst + euftf + freehms + stfedu + stfgov + stfhlth + trstlgl + imwbcnt + rlgatnd + gndr + year + clsprty + age_group, data = filter(dt_filtered, cntry == "SI"))

summary(model_SI)
```
-imwbcnt not statistically significant
-trstlgl, gndr, clsprty stongest predictors

### Baseline Linear Model for Germany

```{r}
model_DE <- lm(trstep ~ ppltrst + euftf + freehms + stfedu + stfgov + 
    stfhlth + trstlgl + imwbcnt + rlgatnd + gndr + year + clsprty + 
    age_group, data = filter(dt_filtered, cntry == "DE"))

summary(model_DE)
```
-year not statistically significant 
-stfgov, trstlgl, gndr strongest predictors


## Interaction with Country for Comparative Analysis
-This tests whether the effect of a variable differs by country.
-The model shows if any predictor significantly interacts with country.
-This means the model allows each predictor to have different effects in Poland and Slovenia, compared to the reference country Germany (baseline).

```{r}
model2 <- lm(trstep ~ (ppltrst + euftf + freehms + stfedu + stfgov + stfhlth + trstlgl + imwbcnt + rlgatnd + gndr + year + clsprty + age_group + cntry) * cntry,
             data = dt_filtered)

summary(model2)
```

*Summary of Main Points*
Key Takeaways
- Legal system trust, EU optimism, and satisfaction with national institutions drive EU trust in all three countries, but the strength of these predictors varies.

- Voting behavior, religiosity, and gender show important country-specific dynamics:

- More religious people trust the EU more in Poland, but less in Germany and Slovenia.

- Gender effect reverses: women trust more in Germany, less in Slovenia.

- Age trends reverse: older Germans trust less, older Poles trust more.

- Time trend: slight decline in EU trust over time in Poland and Slovenia, but no significant change in Germany.

## Diagnostics & Model Assumptions

